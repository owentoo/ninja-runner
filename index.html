<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Ninja Runner â€” SUPER Speed Sync</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      height: 100%; margin: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      background: #f2f2f2;
    }
    #game { max-width: 900px; }
    .hint { font: 12px/1.4 monospace; color: #333; margin-top: 6px; text-align: center; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
</head>
<body>
<canvas id="game"></canvas>
<div class="hint">â†‘/SPACE = jump â€¢ X/click = throw â€¢ R = restart</div>

<script>
(() => {
  // ---------------- constants ----------------
  const W = 800, H = 300;
  const FRAME = { w: 48, h: 48, ptero: { w: 48, h: 24 } };
  const GROUND_Y = 250;

  const SPEED = 300, GRAVITY = 1400, JUMP_VELOCITY = -520;
  const OBSTACLE_BASE_INTERVAL = 1200;

  const MAX_DIFF = 8, DIFF_EVERY_MS = 15000, SPEED_STEP = 25, INTERVAL_FACTOR = 0.92;
  const SHURIKEN_SPEED_BASE = 600;

  // Ground spawns: chance to use the running enemy (mirror ninja)
  const GROUND_ENEMY_PROBABILITY = 0.45;

  const PARALLAX = { clouds:0.20, mountains:0.35, hills:0.55, groundBack:0.95, groundFront:1.15 };

  // Jump forgiveness + variable height
  const COYOTE_TIME_MS = 120;
  const JUMP_BUFFER_MS = 120;
  const JUMP_CUTOFF_FACTOR = 0.5;

  // Shuriken visuals
  const SHURIKEN_DISPLAY = 20;
  const SHURIKEN_BODY = 16;
  const SHURIKEN_SPIN_RPS = 3.0;
  const SHURIKEN_SPIN_VARIANCE = 1.0;

  // Power-up (collectible)
  const POWERUP_SPEED_MULT = 5.0;          // ðŸš€ now 5Ã—
  const POWERUP_DURATION_MS = 6000;        // 6s
  const POWERUP_WARN_MS = 1000;            // last 1s blink warning
  const COLLECTIBLE_BASE_INTERVAL = 10000; // average 10s
  const COLLECTIBLE_INTERVAL_JITTER = 4000;

  new Phaser.Game({
    type: Phaser.CANVAS,
    width: W, height: H,
    backgroundColor: '#87ceeb',
    canvas: document.getElementById('game'),
    physics: { default: 'arcade', arcade: { gravity: { y: GRAVITY }, debug: false } },
    scene: { preload, create, update }
  });

  // --- helper makers ---
  function solid(scene, key, w, h, color) {
    const g = scene.add.graphics();
    g.fillStyle(color, 1).fillRect(0,0,w,h);
    g.generateTexture(key, w, h);
    g.destroy();
  }
  function makePattern(scene, key, w, h, baseColor, stripeColor, stripeStep=6, stripeAlpha=0.18) {
    const g = scene.add.graphics();
    g.fillStyle(baseColor, 1).fillRect(0,0,w,h);
    g.lineStyle(1, stripeColor, stripeAlpha);
    for (let y=stripeStep; y<h; y+=stripeStep) g.strokeLineShape(new Phaser.Geom.Line(0,y,w,y));
    g.generateTexture(key, w, h); g.destroy();
  }
  function makeCollectibleTex(scene) {
    const key='collectible';
    const size=20;
    const g = scene.add.graphics();
    g.fillStyle(0xfff066, 1).fillCircle(size/2, size/2, size/2);
    g.lineStyle(2, 0xffb200, 1).strokeCircle(size/2, size/2, (size/2)-1);
    g.generateTexture(key, size, size);
    g.destroy();
  }

  // --- preload ---
  function preload() {
    solid(this, 'px', 2, 2, 0x000000);

    this.load.image('bgClouds', 'bg_clouds.png');
    this.load.image('bgMountains', 'bg_mountains.png');
    this.load.image('bgHills', 'bg_hills.png');
    this.load.image('groundBackTile', 'ground_back_tile.png');
    this.load.image('groundFrontTile','ground_front_tile.png');

    this.load.spritesheet('ninjaRun', 'ninja_run.png', { frameWidth: 48, frameHeight: 55 });
    this.load.spritesheet('enemyRun', 'ninja_run_enemy.png', { frameWidth: 48, frameHeight: 55 });

    this.load.image('shuriken', 'shuriken.png');
    this.load.image('superBanner', 'super.png');

    makeCollectibleTex(this);
    this.load.image('collectible', 'collectible.png');
  }

  // --- create ---
  function create() {
    const s = this;

    s.gameOver=false; s.score=0; s.difficulty=0;
    s.worldSpeed=SPEED; s.startTime=s.time.now;
    s.speedMult = 1.0; s._prevSpeedMult=1.0; s.invincible=false;

    s.bgClouds    = s.add.tileSprite(0, 60, W*2, 80, 'bgClouds').setOrigin(0,0);
    s.bgMountains = s.add.tileSprite(0, 90, W*2, 90, 'bgMountains').setOrigin(0,0);
    s.bgHills     = s.add.tileSprite(0,130, W*2, 70, 'bgHills').setOrigin(0,0);

    s.superBanner = s.add.tileSprite(0, 0, W*2, GROUND_Y, 'superBanner')
      .setOrigin(0,0).setVisible(false).setAlpha(0.9);

    s.groundBack  = s.add.tileSprite(0, GROUND_Y-8,  W*2, 18, 'groundBackTile').setOrigin(0,0);
    s.groundFront = s.add.tileSprite(0, GROUND_Y-2,  W*2, 28, 'groundFrontTile').setOrigin(0,0);

    const floor = s.physics.add.staticImage(W/2, GROUND_Y+1, 'px').setDisplaySize(W,4).refreshBody();

    s.player = s.physics.add.sprite(120, GROUND_Y, 'ninjaRun', 0).setOrigin(0.5,1).setCollideWorldBounds(true);
    s.player.body.setSize(36,50).setOffset(6,5);
    s.physics.add.collider(s.player, floor);
    s.player.setDepth(4.5);

    // Trail
    s.trailParticles = s.add.particles(0,0,'px',{
      lifespan:220, speed:0, quantity:1, frequency:22,
      scale:{start:1.1,end:0}, alpha:{start:0.65,end:0},
      tint:0x8ef1ff, follow:s.player, blendMode:'ADD'
    });
    s.trailParticles.stop();

    // Animations
    s.anims.create({ key:'base-run', frames:s.anims.generateFrameNumbers('ninjaRun',{start:0,end:7}), frameRate:12, repeat:-1 });
    s.anims.create({ key:'enemy-run', frames:s.anims.generateFrameNumbers('enemyRun',{start:0,end:7}), frameRate:12, repeat:-1 });
    s.anims.create({ key:'ptero-fly', frames:[{key:'ptero0'},{key:'ptero1'}], frameRate:8, repeat:-1 });

    s.obstacles   = s.physics.add.group({ allowGravity:false, immovable:true });
    s.collectibles= s.physics.add.group({ allowGravity:false, immovable:true });
    s.shurikens   = s.physics.add.group({ maxSize:12 });

    s.cursors = s.input.keyboard.createCursorKeys();
    const keyR = s.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.R);
    keyR.on('down', ()=>{ if(s.gameOver) s.scene.restart(); });

    s.lastOnGroundAt=s.time.now; s.jumpQueuedAt=-Infinity; s.jumpReleased=false;
    s.input.keyboard.on('keydown-UP', ()=>{s.jumpQueuedAt=s.time.now;});
    s.input.keyboard.on('keydown-SPACE', ()=>{s.jumpQueuedAt=s.time.now;});
    s.input.keyboard.on('keyup-UP', ()=>{s.jumpReleased=true;});
    s.input.keyboard.on('keyup-SPACE', ()=>{s.jumpReleased=true;});

    s.scoreText = s.add.text(14,12,'SCORE 0',{fontFamily:'monospace',fontSize:16,color:'#000'}).setDepth(10);
    s.gameOverTxt = s.add.text(W/2,H/2-10,'',{fontFamily:'monospace',fontSize:20,color:'#000'}).setOrigin(0.5).setDepth(10);
    s.restartTxt  = s.add.text(W/2,H/2+16,'',{fontFamily:'monospace',fontSize:14,color:'#000'}).setOrigin(0.5).setDepth(10);

    // Collider & overlap logic
    s._obstacleCollider = s.physics.add.collider(s.player, s.obstacles, ()=>{ if(!s.invincible) endGame(s); });
    s.physics.add.overlap(s.player, s.obstacles, (_,o)=>{ if(s.invincible) zapObstacle(s,o); });
    s.physics.add.overlap(s.player, s.collectibles, (_,item)=>{ if(item.active) {item.destroy(); activatePowerUp(s);} });

    s.nextSpawn=0; s.nextCollectible=s.time.now+collectibleInterval();

    s.player.play('base-run');
  }

  // --- helpers (zap, powerup, etc.) ---
  function collectibleInterval(){return COLLECTIBLE_BASE_INTERVAL+Phaser.Math.Between(-COLLECTIBLE_INTERVAL_JITTER,COLLECTIBLE_INTERVAL_JITTER);}
  function zapObstacle(s,o){if(!o||!o.active)return;o.setTint(0x99fffd);s.time.delayedCall(40,()=>{if(o.active)o.destroy();});s.score+=2;}

  function activatePowerUp(s){
    s.invincible=true; s.speedMult=POWERUP_SPEED_MULT;
    s.player.setTint(0x8ef1ff); s.superBanner.setVisible(true);
    s.trailParticles.start(); if(s._obstacleCollider) s._obstacleCollider.active=false;
    s._powerupTimer=s.time.delayedCall(POWERUP_DURATION_MS,()=>deactivatePowerUp(s));
    s._warnTimer=s.time.delayedCall(Math.max(0,POWERUP_DURATION_MS-POWERUP_WARN_MS),()=>startBlink(s));
  }
  function deactivatePowerUp(s){
    s.invincible=false; s.speedMult=1.0; s.player.clearTint();
    s.superBanner.setVisible(false); s.trailParticles.stop();
    if(s._obstacleCollider) s._obstacleCollider.active=true; stopBlink(s);
  }
  function startBlink(s){
    stopBlink(s);
    s._blinkTweenPlayer=s.tweens.add({targets:s.player,alpha:0.45,duration:120,yoyo:true,repeat:Math.ceil(POWERUP_WARN_MS/240)*2});
    s._blinkTweenBanner=s.tweens.add({targets:s.superBanner,alpha:0.4,duration:120,yoyo:true,repeat:Math.ceil(POWERUP_WARN_MS/240)*2});
  }
  function stopBlink(s){
    if(s._blinkTweenPlayer){s._blinkTweenPlayer.stop();s._blinkTweenPlayer=null;}
    if(s._blinkTweenBanner){s._blinkTweenBanner.stop();s._blinkTweenBanner=null;}
    if(s.player) s.player.setAlpha(1);
    if(s.superBanner) s.superBanner.setAlpha(0.9);
  }

  // --- update ---
  function update(time, delta) {
    const s=this;if(s.gameOver)return;
    const now=s.time.now; const dt=delta/1000;
    s.difficulty=Math.min(MAX_DIFF,Math.floor((now-s.startTime)/DIFF_EVERY_MS));
    s.worldSpeed=SPEED+s.difficulty*SPEED_STEP;

    const scroll=s.worldSpeed*s.speedMult;
    s.bgClouds.tilePositionX+=(scroll*PARALLAX.clouds)*dt;
    s.bgMountains.tilePositionX+=(scroll*PARALLAX.mountains)*dt;
    s.bgHills.tilePositionX+=(scroll*PARALLAX.hills)*dt;
    if(s.superBanner.visible) s.superBanner.tilePositionX+=(scroll*0.9)*dt;
    s.groundBack.tilePositionX+=(scroll*PARALLAX.groundBack)*dt;
    s.groundFront.tilePositionX+=(scroll*PARALLAX.groundFront)*dt;

    // --- Sync run animation to SUPER multiplier ---
    if(s.player.anims && s.player.anims.currentAnim && s.player.anims.currentAnim.key==='base-run'){
      s.player.anims.setTimeScale(s.speedMult);
    }

    // Jump logic
    if(s.player.body.blocked.down) s.lastOnGroundAt=now;
    const canCoyote=(now-s.lastOnGroundAt)<=COYOTE_TIME_MS;
    const hasBuffered=(now-s.jumpQueuedAt)<=JUMP_BUFFER_MS;
    if(hasBuffered&&(s.player.body.blocked.down||canCoyote)){s.player.setVelocityY(JUMP_VELOCITY);s.jumpQueuedAt=-Infinity;}
    if(s.jumpReleased&&s.player.body.velocity.y<0){s.player.setVelocityY(s.player.body.velocity.y*JUMP_CUTOFF_FACTOR);s.jumpReleased=false;}

    // Shuriken rotation cleanup omitted here (keep as before)...

    // Score update
    s.scoreText.setText('SCORE '+Math.floor(s.score));
  }
})();
</script>
</body>
</html>
